#!/usr/bin/env bash
# rejects commits that don't match the conventional commit format
# see: www.conventionalcommits.org

commit_types=(
    "build"
    "ci"
    "docs"
    "feat"
    "fix"
    "perf"
    "refactor"
    "revert"
    "style"
    "test"
)

for t in "${commit_types[@]}"; do
    type_alternatives="${type_alternatives:+$type_alternatives}\|$t"
done

type_regex="\($type_alternatives\)"
scope_regex="\((.\+)\)\?"
commit_regex="^$type_regex$scope_regex!\?: .*$"

# strip comment lines
commit_message=$(cat $1 | sed -n '/^#/q;p')

# the commit title if it conforms to the regex
match=$(echo "$commit_message" | head -n1 | grep "$commit_regex")

test ! -z "$match" || {
    printf "$commit_message\ndoesn't match commit format\n$commit_regex\n"
    exit 1
}

if ((${#match} > 50)); then
    printf "$commit_message\nhas a title longer than 50 characters\n"
    exit 1
fi

exit 0
